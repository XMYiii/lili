防MAC欺骗开发指南
1、	MAC地址安全问题
MAC地址安全问题
当接入设备工作在VLAN+MAC转发模式下时，常见的MAC地址安全问题包括三种：仿冒用户MAC地址、仿冒网络设备MAC地址、MAC地址表耗尽。
接入设备支持多种转发模式。当接入设备工作在VLAN+MAC转发模式下时（即VLAN转发模式为vlan-mac模式），报文根据VLAN和MAC地址表项进行转发。VLAN只能由手工配置生成，一般不容易被恶意用户篡改。设备的MAC地址表项既可以由手工配置（即静态MAC地址表项），也可以由设备学习生成（即动态MAC地址表项）。手工配置的静态MAC地址表项一般不容易被恶意用户篡改，因此设备学习的动态MAC地址表项就成为恶意用户攻击的主要对象。在VLAN+MAC转发模式下，恶意用户最常见的一种攻击手段就是利用接入设备的动态MAC地址学习机制，仿冒正常用户或网络设备的源MAC地址对设备的MAC地址表项发起攻击，试图干扰正常的网络通信。常见的MAC地址安全问题包括以下三种：
•	仿冒用户MAC地址 
•	仿冒网络设备MAC地址 
•	MAC地址表耗尽
仿冒用户MAC地址
恶意用户通过仿冒正常用户的源MAC地址接入到网络中，占用正常用户的网络资源，导致正常用户网络中断。以PPPoE拨号上网为例，原理如图1所示。
1.	正常用户User A发送PPPoE拨号报文，源MAC地址为MAC U1。 
2.	接入设备从User A发送的报文中，学习到源MAC地址与端口的对应关系（MAC U1 <----> 0/2/1），记录在MAC地址表中。 
3.	接入设备将User A的拨号报文转发给BRAS。 
4.	BRAS认证通过后，接入设备按照MAC地址表中的对应关系（MAC U1 <-----> 0/2/1），将BRAS发送的目的MAC地址为MAC U1的报文从0/2/1端口转发给User A。User A正常通信。 
5.	恶意用户User B发送PPPoE拨号报文，源MAC地址仿冒成User A的源MAC地址（即MAC U1）。 
6.	接入设备从User B发送的报文中，学习到源MAC地址与端口的对应关系（MAC U1 <----> 0/2/2），刷新MAC地址表中MAC U1对应的表项。这时，系统MAC地址表中MAC U1从0/2/1端口迁移到0/2/2端口。 
7.	接入设备将User B仿冒的拨号报文转发给BRAS。 
8.	BRAS认证通过后，接入设备按照MAC地址表中的对应关系（MAC U1 <----> 0/2/2），将BRAS发送的目的MAC地址为MAC U1的报文通过0/2/2端口转发给User B。
User B仿冒User A的源MAC地址进行通信，占用User A的通信资源，导致User A的通信被中断。原本发送给User A的报文被转发给User B，User B窃取User A的通信数据。
1.1.2 仿冒网络设备MAC地址
恶意用户通过仿冒接入网上层设备的MAC地址，试图窃取所有转发至该上层设备的通信数据。原理如下：
1.	恶意用户发送源MAC地址为接入网上层设备MAC地址的报文。 
2.	接入设备在收到恶意用户仿冒的报文后，按照MAC地址动态学习机制刷新MAC地址表。系统MAC地址表中上层设备MAC地址从上行端口迁移到恶意用户所在的用户端口。 
3.	接入设备将其他用户发送给上层设备的报文转发到恶意用户所在端口。
在未使能二层互通的情况下，用户端口间是二层隔离的，不能进行二层转发。因此，其他用户发往该上层设备的报文会被丢弃，导致通信中断。
1.1.3 MAC地址表耗尽
恶意用户通过仿冒大量不同源MAC地址报文，对接入设备进行攻击，干扰网络通信。原理如下：
1.	恶意用户仿冒大量不同源MAC地址报文。 
2.	接入设备从恶意用户发送的报文中学习到大量的垃圾表项，消耗系统MAC地址表资源。 
3.	MAC地址表资源被耗尽后，接入设备无法学习新的MAC地址，导致其它用户的正常通信报文只能作为未知单播报文处理。 
4.	根据未知单播转发策略，用户报文被广播或丢弃。 
o	当设备使能未知单播抑制时，报文被丢弃，导致部分用户无法上网。 
o	当设备未使能未知单播抑制时，报文被广播，导致消耗大量转发带宽，影响通信质量。
MAC地址的安全防护手段
防御MAC地址欺骗
由动态源MAC地址绑定和动态源MAC地址过滤功能组成。接入设备通过对PPPoE、DHCP、DHCPv6、SLAAC（StateLess Address AutoConfiguration）协议报文的交互过程进行监控，动态生成MAC地址绑定表项和MAC地址过滤表项，并根据该表项来过滤用户发送的MAC地址欺骗报文，防御用户仿冒其他用户或上层设备的源MAC地址。
静态源MAC地址绑定
通过将业务流与用户的静态源MAC地址绑定，既可以防御该用户的MAC地址被其他用户仿冒，又可以防御该用户仿冒其他用户或上层设备的源MAC地址。
静态源MAC地址过滤
通过将接入网上层设备的MAC地址手工配置为源MAC地址过滤，可以保护该上层设备的MAC地址不能被用户作为发送报文的源MAC地址，防御恶意用户发起的仿冒上层设备MAC地址的攻击。
防御MAC地址漂移
MAC地址漂移是指：某个端口的源MAC地址老化之前，设备从另一个端口学习到该源MAC地址，并刷新MAC地址表中源MAC地址和物理端口的对应关系，这就好像是MAC地址从一个端口漂移到另一个端口。为应对恶意用户利用MAC地址漂移原理仿冒其他用户或上层设备的MAC地址，接入设备支持防御MAC地址漂移功能。
VMAC
接入设备通过将用户的源MAC地址替换为设备分配的虚拟MAC地址，确保整个网络MAC地址的唯一性，避免了MAC地址冲突带来的相关问题。同时也能阻止用户的不可信任MAC地址进入运营商网络，防御用户仿冒其他用户或上层设备的源MAC地址。
防MAC地址欺骗
防MAC欺骗
MAC地址欺骗是指：恶意用户通过把自己的源MAC地址伪装成正常用户或网络设备的源MAC地址，试图干扰正常的网络通信。恶意用户通过MAC地址欺骗，造成安全威胁。
防MAC欺骗特性是用户通过PPPoE、DHCP、DHCPv6、SLAAC（StateLess Address AutoConfiguration）方式动态获取IP地址时最常用的一种MAC地址安全防护手段。防MAC欺骗特性由动态源MAC地址绑定和动态源MAC地址过滤功能组成，防御对象如表1所示。使能防MAC欺骗后，会同时使能这两个功能。
表1 防MAC欺骗的两个功能
功能	防御对象
动态源MAC地址绑定	•	仿冒用户MAC地址 
•	MAC地址表耗尽
动态源MAC地址过滤	仿冒网络设备MAC地址
2.	基本原理
防MAC欺骗特性由动态源MAC地址绑定和动态源MAC地址过滤功能组成。首先以DHCP用户为例介绍使能防MAC欺骗后用户上下线流程，然后分别介绍动态MAC地址绑定和动态MAC地址过滤的实现原理。
PS：如果不下捕获，协议报文跟数据报文一样走GE通道，主机LSW学习到VLAN+MAC表项，如果下捕获，协议报文捕获上CPU，走的是VP通道，报文会加VP头，VP头封装了单板MAC地址，主机LSW中学的是单板MAC+VLAN--出端口，下行的时候主机根据UDM表项(如果只开option82会有临时表项)找到流。
 说明： 以下原理描述中的MAC地址都是指源MAC地址，非目的MAC地址。
接入设备通过对PPPoE、DHCP、DHCPv6、SLAAC（StateLess Address AutoConfiguration）协议报文的交互过程进行监控，自动保存用户和服务器的MAC地址表项，并根据MAC地址表项对用户端口收到的报文进行转发或丢弃。以DHCP用户为例，用户上下线流程如图1所示。

