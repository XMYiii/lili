Product name产品名称
Confidentiality level密级
MicroTCA	内部公开
Product version产品版本	Total 11 pages共9页

V100R001	










MicroTCA硬件单板主备倒换实现方式

（仅供内部使用）





Prepared by
拟制		Date
日期	
Reviewed by
审核人		Date
日期	
Reviewed by
审核人		Date
日期	
Authorized by
批准		Date
日期	





 


Huawei Technologies Co., Ltd.
华为技术有限公司
All rights reserved
版权所有 侵权必究
修订记录
日期	修订版本	修改描述	作者
	1.0	初稿完成	
目 录
1	专题概述	6
1.1	实际应用情况	6
1.2	需求和技术点	6
2	SCU的主备倒换	7
3	时钟板的主备倒换	9
3.1	时钟板主备倒换实现方案	9
4	遗留问题跟踪	11

 
表目录
表1 MicroTCA主备倒换技术专题需求和技术点	6
表2 主备倒换电路信号定义	8
图目录
图2 MCH主备倒换系统设计	7
图3 AMC主备倒换系统设计	10
图4 插稳状态检测方式	11

 
1	专题概述
本文详细描述了MicroTCA的主控板（SCU）和业务板(时钟板)的主备倒换策略和实现方式：
1.1	实际应用情况
无。
1.2	需求和技术点
表1 MicroTCA主备倒换技术专题需求和技术点
序号	内容	状态
1	主控板的主备倒换	CLOSE
2	业务板的主备倒换	CLOSE
3		
4		
5		
6		
 
2	SCU的主备倒换
SCU主备倒换设计主备倒换实现方案

在SCU设计中采用主备热备份冗余技术来提高系统可靠性。主备热备份是指相同的两块单板同时工作，一块主用，另一块备用。只能由主用单板输出有效的控制信号或总线信号，备用单板输出的控制信号或总线信号处于无效或关闭状态。当主用的单板出现故障时，系统可靠地切换到无故障的备用板。现主控板到背板的主备倒换的信号定义了ACT_VS、OK_VS、INSLOT_VS和ACT_SELF、OK_SELF、INSLOT_SELF共六个信号。单板有4个插稳信号可以由CPLD来检测，当4个插稳信号都有效后，CPLD输出“在位信号”并保存到寄存器中，可供CPU来查询。

 
图2 MCH主备倒换系统设计




主备倒换电路信号定义如表2：
表2 主备倒换电路信号定义
信号名称	信号方向	信号定义	脉冲信号	0	1
ACT_SLF	OUT	本板主备状态指示位	本板主用	表示信号线故障	备用
OK_SLF	OUT	本板升主使能位/就绪位	升主使能	表示信号线故障	不升主使能
INSLOT_SLF	OUT	本板在位与否状态位	/	本板在位	本板不在位
ACT_VS	IN	对板主备状态指示位	对板主用	表示信号线故障	备用
OK_VS	IN	对板升主使能位/就绪位	升主使能	表示信号线故障	不升主使能
INSLOT_VS	IN	对板在位与否状态位	/	对板在位	对板不在位
ONLINE[3:0]	IN	单板插稳信号	/	表示插稳	表示没有插稳
CPU_OK	IN	本板正常指示信号	正常		
/ACT_STANDBY_INT	OUT	主备倒换中断信号	/	由高到低产生中断	
PARITY_SLOT	IN	奇偶槽位信号			
倒换策略为系统上电后，首先将单板置为不在位、工作状态异常、备用，并且倒换功能关闭；然后判断是否插好、进行自检（BSP对单板硬件的检测最好在单板插好后进行，保证自检结果的正确性，因为某些检测和接口信号有关）；单板插好后根据槽位延时不同的时间打开主备倒换功能，此时才允许单板升主用。在运行过程中，如果单板被拔出，将置为备用、异常，保证再次插入不会抢主用。
单板成为主用的条件
1、本板可靠接入背板槽位。
2、CPU硬件系统正常运行，硬件自检通过。
3、软件完成各端口的初始化，软件自检通过，业务运行正常，软件使能倒换逻辑，本板可以升为主。
单板备用的条件有以下几种情况：
1、单板倒换功能未打开。
	2、对板主用。
	3、本板软件强制倒换，对板在位且正常。
	4、本板工作状态异常，对板在位且正常。
5、其他情况本板主用。
3	 时钟板的主备倒换
3.1	时钟板主备倒换实现方案

AMC背板连接器提供AMC单板的主备倒换的信号为4个，如下表所示。PM会根据单板的插稳信号来给设备管理提供3.3V电源，主控板从设备管理读取单板电子标签和功率等信息，并决定是否给单板提供负载电源，单板在上电后，单板置为备用状态，倒换逻辑关闭，在自检完成并正常后，根据奇偶槽位的不同延时开启主备倒换逻辑，然后根据检测备用板是否主用，是否主用准备好信号来决定是否本板升主。在上电后本板就默认为本板已经插稳，对于是否需要主倒备，不用判断对板是否在位，只根据备板的主用信号和主用使能信号，
单板插稳由PM检测并送到CPLD检测，从图4可以看到，在未插入单板的时候PM检测到的信号是高电平，如果单板插稳后则PM检测到的信号是低电平。
在标准中已经有定义3个三态的槽位号信息管脚，GA0,GA1,GA2。为了能够通过逻辑来检测单板的奇偶槽位，可以通过SD5000输出高低电平到三个信号上，然后SD5000再读信号状态以此来判断GA0,GA1,GA2的状态。在电阻选择上要保证如果信号是高电平，则逻辑输出高地电平后，逻辑读到的一直是高电平，信号是低电平是无论逻辑输出的是高低电平，读到的依然是低电平，当是高阻状态是，输出是高则读到的是高，输出低读到的是低；以此可以确定GA0,GA1,GA2的状态，从而确定单板奇偶槽位。单板的奇偶槽位通过SD5000来告诉CPLD.

 

图3 时钟板主备倒换系统设计



信号名称	信号方向	信号定义	脉冲信号	高电平“1”	低电平“0”
ACT_SLF	Out	本板主用指示信号	脉冲信号表示主用	备用	故障
OK_SLF	Out	升主使能/就绪信号	脉冲信号表示升主使能/就绪	升主未使能/未就绪	故障
ACT_VS	In	对板主用指示信号	脉冲信号表示对板主用	对板备用	故障
OK_VS	In	对板升主使能/就绪信号	脉冲信号表示对板升主使能/就绪	对板升主未使能/未就绪	故障
PARITY_SLOT	IN	奇偶槽位信号			
CPU_OK	IN	本板工作正常	正常		
/ACT_STANDBY_INT	OUT	主备倒换中断		下降沿触发中断	
SD5000_GA[2:0]		槽位地址信号			
CPLD_PS1	IN	单板插稳信号		未插稳	插稳

 
图4 插稳状态检测方式
应用设计指导
序号	关注点
1	
4	遗留问题跟踪
序号	问题	结果	状态
1			



