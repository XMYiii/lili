第3章 OLT表项调度系统方案改进
  本章开始将对上一章中设计的系统模块进行具体的模块化设计，针对当前OLT中表项调度系统中主备倒换机制的时延过长，易产生未知单播的问题对系统中的主备倒换方案进行改进；针对系统中现有MAC地址转发机制存在的MAC地址欺骗的问题，对系统的表项转发方案进行改进，从而来提高OLT的安全性。
3.1 典型的表项调度方案
3.2 优化的表项同步模块
3.3 优化的报文转发模块
目前在二层转发中使用较多并且已经有明确标准定义的报文转发方式是基于MAC地址学习机制来进行。该转发方式通过上行报文根据配置的业务虚端口转发到相应的上行VLAN中，同时设备在MAC地址表中记录VLAN+源MAC在某某业务虚端口上这样一条地址信息。下行报文转发时先根据上行VLAN和报文目的MAC地址查找MAC地址表，如果查找到VLAN+目的MAC在某某业务虚端口上，就把报文转发到该业务虚端口；如果查找不到，就按照未知单播报文处理，广播到VLAN内所有的业务虚端口。基于这个机制，恶意用户可以伪造报文的源MAC地址，对设备发动攻击。例如，恶意用户可以发送源MAC地址不断变化的报文以耗尽设备MAC地址表，影响正常用户报文的MAC学习和转发；恶意用户可以发送源MAC地址为宽带远程接入服务器(Broadband Remote Access Server,BRAS)设备MAC地址的报文，导致正常用户的报文不能被转发给BRAS，而是被转发到恶意用户；恶意用户可以发送源MAC地址为其他正常用户MAC地址的报文，使本应该转发到其他正常用户的报文被转发到恶意用户。
虽然接入网设备（Multi-Service Access Node，MSAN）提供了一系列安全特性以防止上述恶意攻击行为，但是并不能完全解决MAC地址攻击的问题。基于网络安全及实际应用中的需求考虑，设计使网络中的设备尽量不基于用户报文的内容（包括MAC地址）转发，以彻底规避用户伪造报文内容影响设备的转发的方案是很有工程应用价值的。由于接入网相关设备上除了用于承载XDSL用户业务的VLAN之外，还存在管理控制信息与数据信息使用统一物理通道进行传送的属于带内管理的VLAN和用于承载VoIP话音业务的VLAN，这些VLAN仍然需要基于MAC地址学习机制转发报文，而且这些VLAN中报文的MAC地址是可信的，因此需要在MSAN设备提供基于VLAN禁止/使能MAC地址学习的功能。
但在OLT中，需要关闭VLAN的MAC地址学习，原因主要是OLT主控板MAC地址空间有限（SCUL/SCUB 16K，SCUF/SCUN 32K），不足以学习所有用户的MAC地址。动态MAC的老化，可能导致商业用户的业务中断（对N:1用户，处于安全性考虑，需要丢弃未知单播，而我们的系统目前不能基于VLAN丢弃未知单播，导致商业用户的未知单播报文也被丢弃）。这两个问题，在OLT上，对1:1用户（包括商业用户和1:1住宅用户）进行S+C转发；对于N:1用户，基于VLAN使能未知单播丢弃的方式解决；在ONU上，不存在MAC地址空间的问题，仍使用VLAN+MAC转发，同时支持基于VLAN进行配置，对商业用户允许未知单播广播，对住宅用户使能未知单播丢弃。
由3.1所介绍的传统方案采用的报文转发技术会出现一个严重的网络安全问题，即如上文所介绍的MAC地址欺骗问题。这是由于MAC地址学习机制，导致恶意用户可以发送源MAC地址为宽带远程接入服务器(Broadband Remote Access Server,BRAS)设备MAC地址的报文，导致正常用户的报文不能被转发给BRAS，而是被转发到恶意用户。
为了避免在报文转发过程中产生MAC地址欺骗的问题，本文提出了一个优化的报文转发方案，由于3.1所介绍的VLAN帧格式，可知C-VLAN用于标示不同的用户；S-VLAN禁止MAC地址学习。上行报文和以前一样，根据配置的业务虚端口转发，但是将被打上两层VLAN标签，外层标签是S-VLAN，内层标签是C-VLAN。下行报文根据报文的S+C标签进行转发，将报文转发到S+C对应的业务虚端口；如果找不到上行端参数为S+C的业务虚端口，就把报文直接丢弃。显然，在同一个CMSAN上不同业务虚端口的S+C不能相同。由于S+C是运营商配置的，因此在报文转发中完全不需要依赖用户报文的任何内容，彻底解决了用户伪造报文对设备的影响。
3.3.1 VLAN帧格式和类型分析
用于转发的VLAN为Stacking VLAN
配图（）
这四个字节的802.1Q标签头包含了2个字节的标签协议标识（TPID）和2个字节的标签控制信息（TCI）。
TPID（Tag Protocol Identifier）是IEEE定义的新的类型，表明这是一个加了802.1Q标签的帧。TPID包含了一个固定的值0x8100。
TCI是包含的是帧的控制信息，它包含了下面的一些元素：
Priority：这3 位指明帧的优先级。一共有8种优先级，0－7。IEEE 802.1Q标准使用这三位信息。
Canonical Format Indicator( CFI )：CFI值为0说明是规范格式，1为非规范格式。它被用在令牌环/源路由FDDI介质访问方法中来指示封装帧中所带地址的比特次序信息。
关于CFI的说明，我这里有个更详细的描述。
    CFI表示的是以太网帧是否采用规范格式，CFI=0表示规范格式；CFI=1表示非规范格式。所谓的规范格式和非规范格式，指的是以太网帧报文体里面出现的MAC地址是采用低字节在前还是高字节在前的方式，TAG只包含TPID和TCI这两个域，不包含其他域。注意这里说的是报文体中出现的MAC，不是以太网帧头中的MAC。一般在以太网上基本上所有人都用规范格式，所以CFI总是为0。当CFI=1时，其含义与媒体接入控制方法内层服务有关。
VLAN Identified( VLAN ID ):
这是一个12位的域，指明VLAN的ID，一共4096个，每个支持802.1Q协议的交换机发送出来的数据包都会包含这个域，以指明自己属于哪一个VLAN。
在一个交换网络环境中，以太网的帧有两种格式：有些帧是没有加上这四个字节标志的，称为未标记的帧（ungtagged frame），有些帧加上了这四个字节的标志，称为带有标记的帧（tagged frame）。

VLAN类型（我司DSLAM四种基本类型）
Stardard VLAN ：用来限定广播域，即RFC定义的VLAN，标准VLAN内的用户（以太网端口）是互通的。
 Standard VLAN标准VLAN。VLAN中的以太网端口可相互通信，VLAN间的以太网端口相互隔离。只适用于以太网端口口。应用于网管、级联等。不能增加业务虚端口。
Mux VLAN ：用来标识用户，用不同的VLAN区分不同的用户，将VLAN ID带到上层设备作为用户标识。
引入背景：
1、运营商出于安全的考虑，需要接入设备提供一些属性来唯一标识一个用户（防止帐户盗用、公安机关反侦查等）
2、使用Smart Vlan能满足问题1，但没有属性来唯一标识用户了。一个用户分配一个VLAN不就解决问题了吗
特点：
1、每个用户分配一个Vlan，用户之间自然就二层隔离了
2、通过Vlan ID来唯一标识每一个用户(Vlan ID是由接入设备打的，而设备是可靠的)
3、上行口要允许所有用户Vlan通过
4、使用起来很简单很爽，但是很耗Vlan资源的
Smart VLAN ：用于划分用户群，一个用户群一个VLAN，同时隔离VLAN内的用户。
引入背景：
1、接入设备一般都把端口分成上行口（一个或者多个）和下行口（用户端口）。
2、每个下行口需要跟上行口互通，但每个下行口之间不希望二层能够互通
4、把VLAN中的端口属性进一步限制，满足上述需求，这就是Smart Vlan
特点：
1、加入Smart Vlan中的端口区分为上行口和下行口2、下行口之间物理层隔离不能直接互通，下行口与上行口之间正常互通，上行口之间也正常互通
3、报文转发时除了使用MAC地址表外，还要使用端口互通表4、从某种意义上说，Smart Vlan是一种缩小了广播域的Vlan
5、安全性更加提高、很省Vlan资源呀
Super VLAN ：用于节省IP地址，实现跨VLAN的用户在三层的互通，是一个三层接口的VLAN。
3.3.2 改进的报文转发方案
商业用户又分为两种：TLS商业用户和其他商业用户，TLS商业用户指的是透明组网的二层VPN业务，其他商业用户与1:1的住宅用户组网类似，唯一有可能区别的是带宽和优先级的不同。TLS商业用户的处理后面再详述。
对于其他商业用户，采用双层VLAN，CPE和DSLAM分别为每个用户添加不同的CVLAN和SVLAN，并确保每个用户的SVLAN和CVLAN组合的唯一性，对于商业用户，要求关闭SVLAN的MAC学习，下行根据S+C转发。
商业用户模型图（S+C特性文档里）
对于1:1住宅用户，一个用户一个VLAN，采用双层VLAN，在CPE上为每个用户分配一个不同的CVLAN，只允许相应VLAN的报文上行。在DSLAM上，为每个UBP（用户桥接端口。属于研发内部概念） tree的所有1:1住宅用户业务添加一个SVLAN Tag。不同的UBP tree使用不同的SVLAN。
1:1用户模型图
对于商业用户和1:1 住宅用户，使用“S+C转发”。为了使业务在CPE上发放的简单和一致，并保证每个SVLAN都有4K满规格CVLAN，推荐各CPE使用相同的CVLAN来标识不同用户的相同业务（如上图从CPE 1到CPE n，所有用户VoIP业务的CVLAN都是10，其他业务亦同）。在xDSL上首先进行CVLAN的切换（根据业务流Tag切换模式参数配置进行，如图中Tag transform部分所示），然后添加SVLAN，最后按照S+C进行转发。
按VLAN严格S+C转发，即要求整个系统均是按照VLAN转发，不再和MAC地址关联，解决了MAC地址学习和转发带来的固有缺陷
配图处：（严格S+C转发原理图）
如上图所示：在主控板和用户板分别根据S+C转发。下行方向有两级的S+C转发，第一级根据S+C转发到用户板，第二级根据S+C转发到用户端口（或者业务虚端口）。上行方向则只有一级的S+C转发，首先是用户板从用户端口（或者业务虚端口）接收到报文，固定往主控板发送，然后是主控板根据S+C转发到上行口。
上行方向：
	在CPE上行时，一个用户不同CoS优先级的多个业务通过不同CVLAN唯一标识，并映射到同一个VPI/VCI（即同一个UBP）；各个用户使用不同的UBP（即用UBP标识用户，而CVLAN用来标识不同用户的不同业务）。在CPE上添加CVLAN，然后上行至DSLAM。
在DSLAM上为每种业务建立不同的Smart类型的QinQ或Stacking VLAN（每个UBP tree一个），并在对应xDSL业务单板上创建根据CVLAN区分的业务流（各业务单板S+C表项在添加业务流时静态创建，由主机保证<S, C>唯一，不会动态学习、创建表项，但对于业务板上的非S+C业务流，仍要学习SMAC，创建表项）。
对于商业用户报文直接添加SVLAN（信任商业用户的CVLAN），拷贝用户优先级至网络侧（信任商业用户的优先级），后转发至LSW；
对于1：1住宅用户添加SVLAN，同时可以切换CVLAN（目前MA5600T支持修改QinQ或Stacking业务流的CVLAN），并根据配置拷贝用户优先级或替换原优先级，然后转发至LSW。
DSLAM根据端口学习状态决定是否学习MAC地址，并根据SVLAN+DMAC转发至网络侧。对于查表失败的情况，作为未知单播，先检查是否已超过了未知单播门限，如果超过则直接丢弃，否则在VLAN内广播至网络侧（当系统全局关闭MAC学习时，整个DSLAM关闭未知单播抑制，不做门限检查，直接广播至网络侧）。
（L2M里的流程图）
下行方向：
网络侧报文在DSLAM上根据端口学习状态决定是否学习MAC地址后，根据SVLAN+DMAC转发至业务单板。对于查表失败的情况，作为未知单播，先检查是否已超过了未知单播门限，如果超过则直接丢弃，否则在VLAN内广播至业务单板（当系统全局关闭MAC学习时，整个DSLAM关闭未知单播抑制，不做门限检查，直接广播至网络侧）。
在业务板上，对于S+C业务流，根据S+C表转发，如果查不到对应业务流就直接丢弃；对于非S+C业务流，根据VLAN+MAC表转发，如果查不到对应业务流则根据未知单播配置丢弃报文或在VLAN内所有业务流上进行广播。一般来说信任网络侧报文优先级，会根据该优先级进行入队及调度，但在出端口方向要还原用户优先级和CVLAN，最后转发至CPE。
（L2M里面的流程图）
解决方案
主控板MAC地址空间问题
1、我们可以使用N:1 VMAC（PPPoE单MAC）S-VLAN+SessionID 转发
2、S+C转发
     在OLT上，对1:1用户（包括商业用户和1:1住宅用户）进行S+C转发。
     在ONU上，不存在MAC地址空间的问题，仍使用VLAN+MAC转发即可。
动态MAC的老化，影响商业用户
在OLT上，对1:1用户（包括商业用户和1:1住宅用户），我们用S+C转发解决，下行不存在未知单播；对于N:1用户，用基于VLAN使能未知单播丢弃的方式解决。
在ONU上，用VLAN+MAC转发可能存在未知单播的问题，我们支持基于VLAN进行配置，对商业用户允许未知单播广播，对住宅用户使能未知单播丢弃。 
第4章 测试与结果分析
	本章将对上一章提出的OLT表项调度系统中改进的表项同步方案和改进的数据处理方案进行实验验证。根据改进方案的需求设计测试环境并进行搭建，设计测试用例来验证OLT的可靠性和安全性，并对实验结果进行对比分析。
